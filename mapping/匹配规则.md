## 抽个签 App：标签 + 文本双重匹配规则（v0.1）

本文件整理自《标签+文本双重匹配机制.pdf》，用于规范当前项目中所有「签文」内容的匹配与分发逻辑，作为后续脚本与 App 实现的统一依据。

---

### 1. 数据结构总览（单条签文）

每条签文在 JSON 中应至少包含以下字段（含 PDF 原始字段 + 本项目扩展字段）：

- **`tag`**：12 个基础标签之一，代表此签文的**第一主推/原生场景**。
- **`scene_category`**：四大场景之一  
  - 职场/生存 | 外物/得失 | 家庭/关系 | 自我/内省
- **`emotion_state`**：基于原生场景的心理机制描述（不限制是否跨其他场景）。
- **`dimension_v`**：V1 对抗态 | V2 悬浮态 | V3 沉坠态 | V4 舒展态
- **`dimension_e`**：E1 高能 | E2 中能 | E3 低能
- **`sutra_title`**：经文标题（4–6 字）
- **`sutra_text`**：原典原文
- **`ui_translation`**：白话直译
- **`blind_safe`**：`true/false`，是否适合盲抽。
- **`match_weights`**：36 维路由键权重字典（匹配算法「标签权重」部分的唯一来源）
- **`ui_mapping`**：前台展示文本（禁止出现具体场景词汇，如老板、老婆、股票等）。
- **`ui_action`**：微行动指引，强调反直觉松弛感、物理阻断动作、语言冷酷极客。
- **`ai_instruction`**：后台语义锚点，专供向量数据库做文本相似度匹配。
- **`index`**（本项目扩展字段）：用于唯一标识该条签文，方便前端/工具引用。

后续脚本在展示匹配结果时，主要输出以下 6 个字段：

- **标题**：`sutra_title`
- **内容**：`sutra_text`
- **翻译**：`ui_translation`
- **uimapping**：`ui_mapping`
- **微行动**：`ui_action`
- **index**：`index`

---

### 2. 36 维路由键说明（match_weights 的 Key 空间）

前端场景设计：

- **4 大场景**：  
  - 【樊笼】职场/生存 (R3)  
  - 【沉浮】外物/得失 (R4)  
  - 【尘缘】家庭/关系 (R2)  
  - 【方寸】自我/内省 (R1)
- 每个大场景下有若干细分子场景（如：疲于奔命、求之不得、嗔心顿起、妄念纷飞等）。
- 用户点击任意 Tag 后，会出现 3 个归因选项：
  - **Option_A**：贪 / 索取
  - **Option_B**：嗔 / 对抗
  - **Option_C**：痴 / 迷茫

在 JSON 的 `match_weights` 字典中：

- **Key 必须且只能从 36 个标准字符串中选取**，绝不可错字或自造词。
- Key 统一格式为：
  - `"<中文子场景>_Option_A"`  
  - `"<中文子场景>_Option_B"`  
  - `"<中文子场景>_Option_C"`
- 示例：
  - `"樊笼-疲于奔命_Option_A"`
  - `"沉浮-求之不得_Option_B"`
  - `"尘缘-嗔心顿起_Option_C"`
  - `"方寸-妄念纷飞_Option_B"`

**前端 / 工具侧约定：**

- 用户通过界面依次选择：
  - 场景 + 子场景（例如：职场/生存 → 樊笼-疲于奔命）
  - 归因选项 A/B/C（贪/嗔/痴）
- 组合后形成一个标准化路由键：
  - `req_key = "<子场景>_Option_X"`
- 之后所有匹配计算都基于此 `req_key`。

---

### 3. match_weights 配置原则

- **每条签文的 `match_weights` 中，最多配置 3–6 个 Key**：
  - 过多会导致概率稀释，丧失“狙击感”。
- **必须有且仅有一个 Key 得分为 100**：
  - 表示该签文在此路由键上的「最完美契合场景」，确保核心场景必定出招。
- 其他跨界路由键的典型权重范围：
  - 推荐设置在 **30–70** 区间，用于「跨界打击」：
    - 思考标准是：  
      > 一个因为 A 场景点击进来的用户，看到这篇实际上来自 B 场景的解析，会不会觉得被“降维点醒”？  

实现层面，`match_weights` 统一视为：

- `match_weights: { [req_key: string]: number }`
- 若某条签文在某个路由键上没有配置权重，则视为该键的权重为 0。

---

### 4. 匹配算法总览：标签权重 + 语义向量双引擎

系统整体采用：

- **标签权重（粗排）**：基于 `match_weights[req_key]`
- **语义向量相似度（精排）**：基于 `ai_instruction` 与用户输入文本的 Embedding 相似度

并根据「是否有文本输入」分为两种场景。

---

### 4.1 场景一：无文本输入（纯盲抽）

**输入：**

- 用户只选择标签 → 得到路由键 `req_key`。
- 用户没有输入任何文本说明。

**步骤：**

1. 遍历签文库中的每一条记录，构建候选集合 `C`：  
   - 仅当该签文满足 `blind_safe == true` 且在 `match_weights` 中存在键 `req_key`，且对应权重 `w = match_weights[req_key] > 0` 时，才将其加入 `C`。
2. 若候选集合 `C` 为空：  
   - 当前版本约定：直接返回「无可用签文」，由前端/工具层面做相应提示，不做自动降级策略。
3. 在候选集合 `C` 上进行权重轮盘赌：  
   - 计算总权重 `W = Σ w_i`；在 \[0, W) 区间采样一个均匀随机数 `r`。  
   - 顺序遍历 `C`，累加权重，当累计和首次大于 `r` 时，选中该条签文。  
   - 本轮盲抽**只返回 1 条签文**；若需要多条结果，只能由前端/工具显式多次调用本算法。
4. 如需调试或可视化验证，也可以在同一候选集合 `C` 上按 `w` 降序排序展示前 N 条作为辅助视图（仅供内部工具使用）。

**得分公式：**

- 在纯盲抽场景下：
  - `Final_Score = match_weights[req_key]`
  - 不参与任何语义相似度计算。

**输出：**

- 对于最终选中的签文，前端/工具展示：
  - 标题（`sutra_title`）
  - 内容（`sutra_text`）
  - 翻译（`ui_translation`）
  - uimapping（`ui_mapping`）
  - 微行动（`ui_action`）
  - index（`index`）

---

### 4.2 场景二：有文本输入（标签 + 文本精确狙击）

**输入：**

- 用户同样先选择标签 → 得到 `req_key`。
- 用户额外输入一段描述自身情况的文本 `user_text`：
  - 如：「被裁员，感觉很委屈又很迷茫」。

**步骤：**

1. **向量化用户文本：**
   - 对 `user_text` 做 Embedding，得到用户向量 `u_vec`。
2. **向量化签文锚点：**
   - 对每条签文的 `ai_instruction` 做 Embedding，得到向量 `v_vec`。
3. **计算语义相似度：**
   - `semantic_score = cosine_similarity(u_vec, v_vec)`  
   - 数值范围约在 \[0, 1\]。
4. **获取标签权重：**
   - 同样从 `match_weights` 中读取：
     - `w = match_weights.get(req_key, 0)`
5. **融合得分：**
   - 使用 PDF 提供的权重融合公式：
     - `Final_Score = w + semantic_score * 1000`
   - 说明：
     - `1000` 为**可调系数**，目前默认值为 1000，后续可做成配置项。

**排序与结果：**

1. 对所有签文按 `Final_Score` 从高到低排序。
2. 当前版本的实际返回规则：直接取得分最高的那一条签文（Top1）作为匹配结果。  
3. 如需在工具中做调试/人工评估，可在同一排序结果上额外查看前 N 条作为列表，但线上用户侧仍只展示 1 条。  
4. 返回内容同样为：
   - 标题（`sutra_title`）
   - 内容（`sutra_text`）
   - 翻译（`ui_translation`）
   - uimapping（`ui_mapping`）
   - 微行动（`ui_action`）
   - index（`index`）

**直观理解：**

- `w` 决定这条签文**大体上是否在当前路由键的「正确区域」**。
- `semantic_score * 1000` 决定它**是否精准击中了这次用户诉说的具体语义病灶**。
- 当某条签文的 `ai_instruction` 与用户文本高度贴合时：
  - `semantic_score` 会非常高；
  - 放大后会在总分上**碾压**其他仅依赖标签权重的候选；
  - 形成「一枪爆头」式的精准推送。

---

### 5. 前端 / 工具交互约定（当前阶段）

为方便在桌面工具与未来手机 App 中复用，本项目暂定以下交互约定：

- **用户三层选择流程（大场景 → 子场景 → 36 维短句）：**
  1. 先选「大场景」：`樊笼 / 沉浮 / 尘缘 / 方寸` 之一（对应 4 大场景）。
  2. 再选该大场景下的「子场景」：如 `樊笼-疲于奔命`、`沉浮-求之不得` 等（组成 12 个基础标签，即 `tag`）。
  3. 最后在该子场景下，从《系统提示词.md》中对应的 3 条 Option 文案里，选择其一：
     - Option_A（贪）
     - Option_B（嗔）
     - Option_C（痴）
     - 该选择在内部统一映射为标准路由键：`req_key = "<子场景>_Option_X"`，例如 `"樊笼-疲于奔命_Option_B"`。
- **标签选择为必选，文本输入为可选：**
  - 所有匹配逻辑都以路由键 `req_key` 为主线；
  - 是否有文本，决定是否启用语义向量精排。
- **无文本时：**
  - 严格按照「场景一：无文本输入（纯盲抽）」逻辑，仅使用 `match_weights[req_key]`。
- **有文本时：**
  - 严格按照「场景二：有文本输入（标签 + 文本精确狙击）」逻辑，使用：
    - `Final_Score = match_weights[req_key] + semantic_score * 1000`
- **结果展示字段固定为：**
  - 标题（`sutra_title`）
  - 内容（`sutra_text`）
  - 翻译（`ui_translation`）
  - uimapping（`ui_mapping`）
  - 微行动（`ui_action`）
  - index（`index`）

---

### 6. 扩展与待定事项（可在后续讨论中完善）

以下内容在 PDF 中未完全细化，或与具体实现、产品形态强相关，可在后续迭代中逐项敲定：

- **轮盘赌 vs 排序的具体使用场景：**
  - 盲抽体验倾向使用轮盘赌；
  - 调试 / 内部工具倾向使用按权重或总分排序。
- **语义得分放大系数 `1000` 的调参策略：**
  - 后续可通过 A/B Test 或人工评估动态调整；
  - 也可以做成「按场景配置」的超参数。
- **是否支持多标签联合匹配（多选 Tag）：**
  - 若未来支持多选，可讨论：
    - 多个 `req_key` 的权重如何融合；
    - 是否对不同标签赋予不同优先级。
- **Embedding 实现细节：**
  - 具体选用哪种向量模型、维度、归一化方式等留给底层引擎实现；
  - 本规则文档只约束「需要可比较的语义向量」及「使用余弦相似度」这一层。

本文件作为后续所有匹配脚本与 App 功能的「规则底座」，若有新增需求或发现与实际体验不符的地方，应优先在此文档中更新规则，再同步到代码实现。

---

### 7. 用户反馈与学习机制（预案）

为便于后续通过机器学习或规则迭代逐步优化 `match_weights` 与 `blind_safe`，本项目在盲抽流程外引入**轻量级反馈记录机制**。

#### 7.1 反馈记录文件

- 反馈统一记录在 `mapping/feedback_log.jsonl` 中，使用 JSON Lines 格式（每行一条独立 JSON）。
- 该文件**只追加不覆盖**，用于长期积累抽签与感受数据。

#### 7.2 单条反馈结构（建议初版）

每一次「抽签 + 人工评价」对应一条记录，字段建议如下：

- **定位信息**：
  - `source`：文本来源（与签文中的 `source` 字段一致，例如 `liuzutanjing`）。  
  - `index`：签文编号（与 `tanjing.json` 中的 `index` 对应）。`source + index` 共同构成全局唯一主键。
  - `req_key`：本次抽签使用的路由键（如 `"樊笼-疲于奔命_Option_B"`）。
  - `timestamp`：ISO8601 时间戳（例如 `2026-02-28T12:34:56`）。
- **主观反馈字段**：
  - `hit_score`：命中程度评分（例如 1–5，数值越大代表越「准」）。
  - `analysis_quality`：对解析文本（`ui_mapping`）质量的主观评分（例如 1–5）。
  - `blind_safe_suggestion`：是否认为该签文适合盲抽的主观判断：
    - `"keep"`：认为当前 `blind_safe` 状态可以保持不变；
    - `"should_be_blind_safe"`：认为应纳入盲抽（若当前为 false）；
    - `"should_not_be_blind_safe"`：认为不宜盲抽（应从盲抽池中移除）。
  - `comment`：自由文本备注（可选，用于记录特别印象或边界情况）。

示例（单行）：

```json
{"source": "liuzutanjing", "index": 37, "req_key": "樊笼-疲于奔命_Option_B", "timestamp": "2026-02-28T12:34:56", "hit_score": 5, "analysis_quality": 4, "blind_safe_suggestion": "keep", "comment": "命中感很强，但略偏锋利。"}
```

#### 7.3 界面/工具层交互建议

- 在抽签结果展示区域下方增加「反馈」区域，包括：
  - 命中程度评分控件（例如 1–5 分选择）。
  - 解析质量评分控件（例如 1–5 分选择）。
  - 「是否适合盲抽」三选一控件。
  - 可选的多行文本输入框。
  - 「保存反馈」按钮：点击后，根据当前抽中的签文与上述输入，向 `feedback_log.jsonl` 追加一行 JSON。
- 当前阶段：反馈仅记录，不自动调整 `match_weights` 或 `blind_safe`，所有逻辑仍以本规则文档为准。

#### 7.4 后续学习与更新（留待后续实现）

后续可以通过独立脚本或服务，对 `feedback_log.jsonl` 做聚合分析，例如：

- 统计某条签文在某个 `req_key` 下的平均 `hit_score` 与出现次数；
- 找出「命中率长期偏低」的签文/路由组合，建议降低对应 `match_weights[req_key]` 或移除该挂载；
- 统计被多次标记为 `"should_not_be_blind_safe"` 的签文，建议将其 `blind_safe` 调整为 `false`；
- 综合多维反馈，设计规则或训练模型，周期性生成对 `tanjing.json` 的「参数更新建议」，由人审阅后再真正写回。

在正式启用自动更新之前，建议始终保留**人工审核环节**：即由策划/研究者先查看反馈统计与更新建议，再决定是否修改源 JSON 配置。
